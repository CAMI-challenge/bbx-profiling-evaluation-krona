#!/bin/bash

set -o errexit
set -o nounset

TASK=$1
OUTPUT=/bbx/mnt/output
INPUT=/bbx/mnt/input/biobox.yaml
METADATA=/bbx/mnt/metadata

#validate
validate-biobox-file     \
   --input ${INPUT}      \
   --schema /schema.yaml \

# Run the given task
CMD=$(egrep ^${TASK}: /Taskfile | cut -f 2 -d ':')
if [[ -z ${CMD} ]]; then
  echo "Abort, no task found for '${TASK}'."
  exit 1
fi

# if /bbx/metadata is mounted create log.txt
if [ -d "$METADATA" ]; then
  CMD="($CMD) >& $METADATA/log.txt"
fi

# Parse the read locations from this file
PREDICTION=$(yaml2json < ${INPUT} \
        | jq --raw-output '.arguments.prediction.path' )

eval ${CMD}

htmlParser.py --input  ${OUTPUT}/out.html  --output ${OUTPUT}/standalone_out.html --krona /krona.js

cat << EOF > ${OUTPUT}/biobox.yaml
version: 0.1.0
results:
  - name: HTML
    type: html
    inline: false
    value: standalone_out.html
    description: A summary of multiple metrics.
EOF
